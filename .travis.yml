language: python

python:
  - "3.5"

matrix:
  include:
    # Default test suite
    - services:
      - docker

      sudo: required

      cache:
        - directories:
          - node_modules
          - course_discovery/static/bower_components

      before_install:
          - make travis_up

      install:
        - docker exec -t discovery bash -c 'apt update && apt install -y xvfb firefox gettext wget'
        - docker exec -t discovery bash -c 'sed -i "s/course_discovery.settings.devstack/course_discovery.settings.test/" /edx/app/discovery/discovery_env'
        - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && make requirements'

      script:
          - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && make clean_static'
          - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && make static'
          - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && xvfb-run make test'

      after_success:
          - pip install -U codecov
          - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && coverage xml'
          - codecov

    # Default test suite setup
    - services:
      - docker

      sudo: required

      cache:
        - directories:
          - node_modules
          - course_discovery/static/bower_components

      before_install:
          - make travis_up

      install:
        - docker exec -t discovery bash -c 'apt update && apt install -y xvfb firefox gettext wget'
        - docker exec -t discovery bash -c 'sed -i "s/course_discovery.settings.devstack/course_discovery.settings.test/" /edx/app/discovery/discovery_env'
        - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && make requirements'

      script:
          - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && make clean_static'
          - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && make static'

      after_success:
          - pip install -U codecov
          - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && coverage xml'
          - codecov

    # i18n
    - services:
      - docker

      sudo: required

      cache:
        - directories:
          - node_modules
          - course_discovery/static/bower_components

      before_install:
          - make travis_up

      install:
        - docker exec -t discovery bash -c 'apt update && apt install -y xvfb firefox gettext wget'
        - docker exec -t discovery bash -c 'sed -i "s/course_discovery.settings.devstack/course_discovery.settings.test/" /edx/app/discovery/discovery_env'
        - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && test make-requirements'

      script:
          - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && make docs'
          - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && make validate_translations'

    # Quality
    - services:
      - docker

      sudo: required



      cache:
        - directories:
          - node_modules
          - course_discovery/static/bower_components

      before_install:
          - make travis_up

      install:
        - docker exec -t discovery bash -c 'sed -i "s/course_discovery.settings.devstack/course_discovery.settings.test/" /edx/app/discovery/discovery_env'
        - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && make test-requirements'

      script:
          - docker exec -t discovery bash -c 'source /edx/app/discovery/discovery_env && cd /edx/app/discovery/discovery/ && make quality'


    - script:
      - python success.py

    - script:
      - python failure.py
