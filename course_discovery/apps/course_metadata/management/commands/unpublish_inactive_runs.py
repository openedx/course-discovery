import logging

from django.core.management import BaseCommand, CommandError
from django.db.transaction import atomic
from django.utils.translation import ugettext as _

from course_discovery.apps.course_metadata.choices import CourseRunStatus
from course_discovery.apps.course_metadata.exceptions import UnpublishError
from course_discovery.apps.course_metadata.models import CourseRun

logger = logging.getLogger(__name__)


class Command(BaseCommand):
    help = 'Unpublishes marketing site URLs from any old inactive course runs to newer active runs'

    def handle(self, *args, **options):
        success = True

        # Since we know we will call unpublish_inactive_runs for nearly every single course in our catalog, let's
        # try to optimize a little bit by only making one database query. We ask for all course runs, sort by course,
        # then hand the set of published course runs into unpublish_inactive_runs.
        published_runs = CourseRun.objects.filter(status=CourseRunStatus.Published).order_by('course').iterator()

        current_course = None
        current_runs = set()

        # Iterate through all published runs, gather up all the runs for a given course, group them, and
        # send them to unpublish_inactive_runs.
        for run in published_runs:
            if current_course and current_course != run.course:
                success = self.update_course(current_course, current_runs) and success
                current_runs = set()

            current_course = run.course
            current_runs.add(run)

        # and handle the last group of runs too
        if current_runs:
            success = self.update_course(current_course, current_runs) and success

        self.unpublish_edx_org_accidental_courses()

        if not success:
            raise CommandError(_('One or more courses failed to unpublish.'))

    @staticmethod
    def update_course(course, runs):
        try:
            if course.unpublish_inactive_runs(published_runs=runs):
                logger.info(_('Successfully unpublished runs in course {key}').format(key=course.key))
            return True
        except UnpublishError:
            logger.exception(_('Failed to unpublish runs in course {key}').format(key=course.key))
            return False

    @staticmethod
    def unpublish_edx_org_accidental_courses():
        """
        We accidentally republished too many courses - here we are manually undoing that.
        Will delete shortly, before this makes it into any Open edX releases.
        """
        # pylint: disable=line-too-long
        keys = ('BerkeleyX/BJC.1x/3T2015', 'BerkeleyX/BJC.2x/3T2015', 'BerkeleyX/BJC.3x/1T2016', 'BerkeleyX/BJC.4x/1T2016', 'BerkeleyX/ColWri.2.2x/1T2015', 'BerkeleyX/ColWri2.3x_2/1T2015', 'BerkeleyX/ColWri_2.1x/3T2014', 'BerkeleyX/CS-169.2x/2013_Summer', 'BerkeleyX/CS-184.1x/2013_October', 'BerkeleyX/CS.169.2x/3T2013', 'BerkeleyX/CS.CS169.1x/3T2013', 'BerkeleyX/CS184.1x/2013_Spring', 'BerkeleyX/CS_184.1x/3T2014', 'BerkeleyX/J4SC101/1T2015', 'BerkeleyX/Stat2.1x/2013_Spring', 'BerkeleyX/Stat2.2x/2013_April', 'BerkeleyX/Stat2.3x/2013_SOND', 'BerkleeX/BCM-MB110x/1T2014', 'BerkleeX/BMPR365_2x/3T2014', 'BerkleeX/MB110_3x/3T2014', 'CornellX/HIST1514x_Fall2014/3T2014', 'CornellX/HOSP.101x/1T2015', 'CornellX/INFO2040x_Spring2015/1T2015', 'course-v1:ACCA+FA1-MA1.X+3T2017', 'course-v1:ACCA+FA2-MA2.X+3T2017', 'course-v1:AdelaideX+AnalysisX+3T2018', 'course-v1:ANUx+ANU-INDIA1x+4T2015', 'course-v1:ASUx+AST111+3T2015', 'course-v1:ASUx+CEE181x+2181A', 'course-v1:ASUx+CSE110x+2181BS', 'course-v1:ASUx+HST102+3T2015', 'course-v1:ASUx+TGM579x+2T2019', 'course-v1:BerkeleyX+BJC.12x+3T2016', 'course-v1:BerkeleyX+ColWri.3.10+1T2016', 'course-v1:BerkeleyX+ColWri.3.8x+3T2015', 'course-v1:BerkeleyX+ColWri11.1x+3T2016', 'course-v1:BerkeleyX+ColWri2.3x+1T2016', 'course-v1:BerkeleyX+ColWri3.1x-2+3T2015', 'course-v1:BerkleeX+BMPR365_3x+1T2015', 'course-v1:BerkleeX+MB110_4x+1T2015', 'course-v1:BerkleeX+OHARM-100x+2T2017', 'course-v1:BUx+ARPO222x+1T2016', 'course-v1:BUx+ASTR105x+2T2015', 'course-v1:BUx+ComplianceX+4T2015', 'course-v1:BUx+GlobalHealthX.1+3T-2015', 'course-v1:BUx+GlobalHealthX.2+1T2016', 'course-v1:BUx+GlobalHealthX.3+1T2016', 'course-v1:BUx+INTL301x+4T2015', 'course-v1:BUx+ITOP1x+3T-2015', 'course-v1:BUx+Math226.1x+2T2017', 'course-v1:BUx+Math226.2x+2T2017', 'course-v1:BUx+Math226.3x+3T2017', 'course-v1:CaltechX+CS_1156x+3T2016', 'course-v1:CaltechX+Ec1011x_2+T12015', 'course-v1:ChalmersX+ChM003x+1T2016', 'course-v1:ColumbiaX+FOE1x+2T2016', 'course-v1:ColumbiaX+WHAW1.1x+3T2016', 'course-v1:ColumbiaX+WHAW1.2x+1T2017', 'course-v1:CornellX+HOSP.101x_1+1T2016', 'course-v1:DartmouthX+DART.ENGS.01.X+2015_T2', 'course-v1:DavidsonNext+Cal_APBCx+3T2017', 'course-v1:DavidsonNext+Phy_APccx+3T2017', 'course-v1:DelftX+AdvCRM1x+3T2015', 'course-v1:DelftX+AEASM513x+3T2016', 'course-v1:DelftX+CalcSP01x+3T2015', 'course-v1:DelftX+EX101x+2T2018', 'course-v1:DelftX+EX102x+2T2018', 'course-v1:DelftX+IDEMC.3x+2T2017', 'course-v1:DelftX+LfE101x+3T2017', 'course-v1:DelftX+MBA1.0x+3T2017', 'course-v1:DelftX+RCUC101x+1T2017', 'course-v1:DelftX+TBP01x+T32017', 'course-v1:DelftX+TP102x+2T2017', 'course-v1:DelftX+TXT1x+3T2015', 'course-v1:DoaneX+HPH-101X+1T2018a', 'course-v1:DoaneX+HPH-102X+1T2018a', 'course-v1:DoaneX+HPH-103X+1T2018a', 'course-v1:edX+DevSec101+3T2018', 'course-v1:edX+JOB101x+2015', 'course-v1:EPFLx+NavigatorX+3T2017', 'course-v1:EPFLx+PlasmaX+T12016', 'course-v1:GalileoX+CAAD001X+1T2019', 'course-v1:GalileoX+CAAD002X+1T2019', 'course-v1:GalileoX+CAAD003X+1T2019', 'course-v1:GalileoX+CAAD004X+1T2019', 'course-v1:GalileoX+CAAD005X+1T2019', 'course-v1:GalileoX+CMath001x+2T2016', 'course-v1:GalileoX+CNeg001x+2T2016', 'course-v1:GalileoX+CTec001x+2T2016', 'course-v1:GeorgetownX+GUIX-501-02x+2015_3T', 'course-v1:GeorgetownX+PHLX101-02x+1T2015', 'course-v1:GeorgetownX+PHLX101-03x+2T2016', 'course-v1:GTx+CS1301+1T2017', 'course-v1:GTx+CS1301x+1T2017', 'course-v1:GTx+CS6035+2T2019a', 'course-v1:GTx+CS6262+2T2019a', 'course-v1:GTx+CS6265+2T2019', 'course-v1:GTx+CS6300+2T2019a', 'course-v1:GTx+CS6400+2T2018', 'course-v1:GTx+CS6400x+2T2019a', 'course-v1:GTx+CS6750+2T2019a', 'course-v1:GTx+CS7641x+2T2017', 'course-v1:GTx+CSE6242+2T2019', 'course-v1:GTx+CSE6250+2T2017', 'course-v1:GTx+CS_ECE_PUBP6725+2T2019a', 'course-v1:GTx+ECE8813+2T2019a', 'course-v1:GTx+ISYE6402+2T2019', 'course-v1:GTx+ISYE6414x+2T2019a', 'course-v1:GTx+ISYE6420+2T2019', 'course-v1:GTx+ISYE6644x+2T2019a', 'course-v1:GTx+ISYE6669+2T2019', 'course-v1:GTx+ISYE8803+2T2019a', 'course-v1:GTx+MGT6311+2T2019a', 'course-v1:GTx+MGT6753x+2T2019a', 'course-v1:GTx+MGT6754+2T2018', 'course-v1:GTx+MGT8813+2T2019a', 'course-v1:GTx+MGT8823+2T2019a', 'course-v1:HarvardX+1368.1x+2T2016', 'course-v1:HarvardX+1368.2x+2T2016', 'course-v1:HarvardX+1368.3x+2T2016', 'course-v1:HarvardX+1368.4x+2T2016', 'course-v1:HarvardX+AmPoX.1+3T2017', 'course-v1:HarvardX+AmPoX.2+3T2017', 'course-v1:HarvardX+AmPoX.4+2T2017', 'course-v1:HarvardX+EMC2x+2T2016', 'course-v1:HarvardX+GSE4x+3T2017', 'course-v1:HarvardX+HKS101A+1T2017', 'course-v1:HarvardX+PH556+1T2017', 'course-v1:HarvardX+PH557+3T2015', 'course-v1:HarvardX+SPU27x+2T2017', 'course-v1:HKPolyUx+EWA.1.2x+3T2015', 'course-v1:HKPolyUx+EWA.1x+3T2015', 'course-v1:HKPolyUx+EWA1.1x+2T2018', 'course-v1:HKPolyUx+EWA1.2x+2T2018', 'course-v1:HKPolyUX+SHTM001x+2T2016', 'course-v1:HKUSTx+COMP107x+3T2019', 'course-v1:HKUx+HKU05.1x+3T2016', 'course-v1:IDBx+23+1T2020a', 'course-v1:IDBx+IDB6.4x+3T2018', 'course-v1:IDBx+IDB8x+1T2018', 'course-v1:IDBx+IDB_LSC101x+2015_T4', 'course-v1:IEEEx+ATG1.x+1T2017', 'course-v1:IEEEx+ATG2.x+3T2016', 'course-v1:IEEEx+BioMed01x+2T2017', 'course-v1:IEEEx+CloudIntro.x+3T2017', 'course-v1:IEEEx+CS01+2T2016', 'course-v1:IEEEx+FOE01.x+3T2017a', 'course-v1:IEEEx+IEEEStuff.x+T1_2017', 'course-v1:IEEEx+IntroData.x+2016_T3', 'course-v1:IEEEx+MCExam01x+2015_T3', 'course-v1:IEEEx+MGT_MDW+3T2016', 'course-v1:IEEEx+MTX.1x+2015Q3', 'course-v1:IEEEx+NESC01x+1T2017', 'course-v1:IEEEx+RTSIx+1T2016', 'course-v1:IEEEx+SCHC.x+3T2016', 'course-v1:IEEEx+SmartGrid.x+2016_T2', 'course-v1:IEEEx+SmartGrid01.x+3T2016', 'course-v1:IEEEx+SmartGrid02.x+3T2016', 'course-v1:IEEEx+Standards01.x+1T2017', 'course-v1:IEEEx+Storage101x+1T2017', 'course-v1:IEEEx+SysBio1x+3T2016', 'course-v1:IEEEx+TOGAF.x+1T2017', 'course-v1:IIMBx+ES101.1x+3T2015', 'course-v1:IMF+FMAx+1T2017', 'course-v1:IMF+FPP.1x+3T2017', 'course-v1:IMF+Sp_FPP.1x+1T2017', 'course-v1:IMFx+AR.FPP.1x+1T2018', 'course-v1:IMFx+FPP.1x_2015+2015_T2', 'course-v1:IMFx+FPP.1x_2016+2T2016', 'course-v1:IMFx+FPP.1x_fr+3T2017', 'course-v1:IRTIx+IFB1x+1T2017', 'course-v1:IsraelX+218.4444x+3T2017', 'course-v1:JaverianaX+GTHx+2T2019', 'course-v1:JaverianaX+IMP2.0x+1T2017', 'course-v1:JaverianaX+PUJ.E.1601x.06+2016_T1', 'course-v1:JuilliardX+JCx001+2T2017', 'course-v1:JuilliardX+JX001x+3T2017', 'course-v1:JuilliardX+Jx002x+3T2017', 'course-v1:JuilliardX+JX003x+2T2017', 'course-v1:JuilliardX+JX004x+2T2017', 'course-v1:JuilliardX+JX005x+3T2017', 'course-v1:JuilliardX+JX006x+3T2017', 'course-v1:KironX+X1+3T2017', 'course-v1:KIx+KIexploRx+2015T3', 'course-v1:KyotoX+006x+1T2017', 'course-v1:LinuxFoundationX+LFS101x.2+1T2015', 'course-v1:LinuxFoundationX+LFS103x+2T2017', 'course-v1:LinuxFoundationX+LFS201x+2T2015', 'course-v1:LouvainX+ConfX+2T2015', 'course-v1:LouvainX+Louv17x+3T2016', 'course-v1:MandarinX+MX101x+2T2016', 'course-v1:MandarinX+MX102x+2T2017', 'course-v1:MandarinX+MX103x+1T2017', 'course-v1:MandarinX+MX801x+1T2017', 'course-v1:MandarinX+MX901x+3T2017', 'course-v1:McGillX+CHEM181x_3+3T2016', 'course-v1:McGillX+POP123x+3T2017', 'course-v1:MexicoX+ACF.0903.1x+3T2015', 'course-v1:MexicoX+CCT.101x+3T2015', 'course-v1:MexicoX+CMLT1x+3T2015', 'course-v1:MexicoX+Colef01.1x+3T2015', 'course-v1:MexicoX+ETV.001x+3T2015', 'course-v1:MexicoX+G01x+3T2015', 'course-v1:MexicoX+IIIDRn101x+2015_T3', 'course-v1:MexicoX+SDSJ01x+3T2015', 'course-v1:MexicoX+UPEVIPN01x+T32015', 'course-v1:MexicoX+UPEVIPN02x+T2015', 'course-v1:MexicoX+UPEVIPN03x+T32015', 'course-v1:MexicoX+UPN001x+3T2015', 'course-v1:MexicoX+UPN002x+3T2015', 'course-v1:MichiganX+FIN101x+2T2019', 'course-v1:MichiganX+FIN101x_002s+2T2017', 'course-v1:MichiganX+FIN401x+3T2018', 'course-v1:MichiganX+FIN402x+3T2018', 'course-v1:MichiganX+FIN403x+3T2018', 'course-v1:MichiganX+FIN404x+3T2018', 'course-v1:MichiganX+UX2+2T2018', 'course-v1:MichiganX+UX4+3T2016', 'course-v1:MichiganX+UX501x+3T2018', 'course-v1:MichiganX+UX503x+1T2018', 'course-v1:MichiganX+UX504x+1T2018', 'course-v1:MichiganX+UX509x+2T2017', 'course-v1:MichiganX+UXD1+3T2016', 'course-v1:MichiganX+UXD5+1T2018', 'course-v1:MichiganX+UXD6+2T2018', 'course-v1:MichiganX+UXDC+1T2017', 'course-v1:MichiganX+UXR1+3T2016', 'course-v1:MichiganX+UXR5+2T2018', 'course-v1:MichiganX+UXR6+1T2017', 'course-v1:MichiganX+UXRC+1T2017', 'course-v1:Microsoft+205x+1T2016', 'course-v1:Microsoft+AZURE201x+3T2016', 'course-v1:Microsoft+AZURE211x+1T2018', 'course-v1:Microsoft+AZURE216x+2T2019', 'course-v1:Microsoft+CLD1003x+1T2016', 'course-v1:Microsoft+CLD201x+2015_T4', 'course-v1:Microsoft+CLD202x+2T2016', 'course-v1:Microsoft+CLD203x+1T2016', 'course-v1:Microsoft+CLD204x+1T2018a', 'course-v1:Microsoft+CLD206+3T2015', 'course-v1:Microsoft+CLD234x+1T2018a', 'course-v1:Microsoft+DAT203.3x+1T2018', 'course-v1:Microsoft+DAT203x+3T2015', 'course-v1:Microsoft+DAT206x_JPN+4T2017', 'course-v1:Microsoft+DAT209x+1T2018a', 'course-v1:Microsoft+DAT210x+1T2018', 'course-v1:Microsoft+DAT212x+1T2018', 'course-v1:Microsoft+DAT215.3x+3T2017', 'course-v1:Microsoft+DAT215.4x+1T2018a', 'course-v1:Microsoft+DEV201x+1T2016', 'course-v1:Microsoft+DEV202.1x+2015_T4', 'course-v1:Microsoft+DEV202.2x+2015_T4', 'course-v1:Microsoft+DEV202.3x+2015_T4', 'course-v1:Microsoft+DEV202x+2015_T2', 'course-v1:Microsoft+DEV205Bx+3T2017', 'course-v1:Microsoft+DEV205x+2T2016', 'course-v1:Microsoft+DEV206.1x+3T2015', 'course-v1:Microsoft+DEV206.2x+3T2015', 'course-v1:Microsoft+DEV207.1x+1T2016', 'course-v1:Microsoft+DEV211.1x+1T2018', 'course-v1:Microsoft+DEV213.1x+2T2016', 'course-v1:Microsoft+DEV213.2x+2T2016', 'course-v1:Microsoft+DEV215x+3T2017', 'course-v1:Microsoft+DEV217x+3T2016', 'course-v1:Microsoft+DEV233x+3T2017', 'course-v1:Microsoft+DEV238x+2T2019', 'course-v1:Microsoft+DEV337x+2T2018', 'course-v1:Microsoft+DIS50.1x+1T2016', 'course-v1:Microsoft+DIS50.2+3T2015', 'course-v1:Microsoft+DIS50.3x+2T2016', 'course-v1:Microsoft+INF1002x+2T2016', 'course-v1:Microsoft+INF201.12x+3T2015', 'course-v1:Microsoft+INF201.13x+3T2015', 'course-v1:Microsoft+INF201x+2015_T4', 'course-v1:Microsoft+INF202x+3T2015', 'course-v1:Microsoft+INF213x+1T2018a', 'course-v1:Microsoft+INF214x+1T2018a', 'course-v1:Microsoft+INF215x+1T2018a', 'course-v1:Microsoft+INF216x+1T2018', 'course-v1:Microsoft+INF221x+1T2018', 'course-v1:Microsoft+INF500.01x+2T2016', 'course-v1:Microsoft+INF500.02x+2T2016', 'course-v1:Microsoft+INF500.03x+2T2016', 'course-v1:Microsoft+INF500.04x+2T2016', 'course-v1:Microsoft+INF500.05x+2T2016', 'course-v1:Microsoft+MTA001+1T2018', 'course-v1:Microsoft+MTA002+1T2018', 'course-v1:MITx+10.03x+2T2015', 'course-v1:MITx+10.03x_3+2T2016', 'course-v1:MITx+11.405x_2+1T2017', 'course-v1:MITx+14.73x_1+1T2016', 'course-v1:MITx+14.74x+3T2015', 'course-v1:MITx+15.071x_2a+2T2015', 'course-v1:MITx+15.071x_3+1T2016', 'course-v1:MITx+15.390.1x_1+1T2015', 'course-v1:MITx+15.390.1x_1_TUR+1T2015', 'course-v1:MITx+15.390.1x_SPA_1+2T2016', 'course-v1:MITx+15.390.2x_1+2T2015', 'course-v1:MITx+15.390.2x_1_TUR+2T2015', 'course-v1:MITx+15.390.2x_SPA_1+2T2016', 'course-v1:MITx+15.662x_2+1T2016', 'course-v1:MITx+15.662x_3+1T2017', 'course-v1:MITx+15.671x+3T2015', 'course-v1:MITx+16.101x_2+3T2015', 'course-v1:MITx+2.01x_3+2T2016', 'course-v1:MITx+20.305x_2+1T2017', 'course-v1:MITx+21W.789.1x+1T2016', 'course-v1:MITx+21W.789.3x+1T2016', 'course-v1:MITx+21W.789.4x+1T2016', 'course-v1:MITx+21W.789.5x+2T2016', 'course-v1:MITx+3.032.1x_1+3T2016', 'course-v1:MITx+3.032.2x_1+3T2016', 'course-v1:MITx+3.032.3x_1+3T2016', 'course-v1:MITx+3.054.1x+1T2019', 'course-v1:MITx+3.054.2x+1T2016', 'course-v1:MITx+3.054.3x+2T2016', 'course-v1:MITx+3.091x_4+1T2015', 'course-v1:MITx+3.091x_5+3T2015', 'course-v1:MITx+4.605x_3+3T2015', 'course-v1:MITx+4.605x_4+3T2016', 'course-v1:MITx+6.002.1x_1+2T2016', 'course-v1:MITx+6.002.2x_1+2T2016', 'course-v1:MITx+6.002.3x_1+2T2016', 'course-v1:MITx+6.002.Ax+3T2015', 'course-v1:MITx+6.002.Bx+3T2015', 'course-v1:MITx+6.002.Cx+3T2015', 'course-v1:MITx+6.002x_6x+1T2015', 'course-v1:MITx+6.041.1x+3T2017', 'course-v1:MITx+6.341x_1+3T2015', 'course-v1:MITx+7.00x_3+2T2015', 'course-v1:MITx+7.00x_4+2T2016', 'course-v1:MITx+7.00x_5+3T2016', 'course-v1:MITx+7.28.1x_1+2T2015', 'course-v1:MITx+7.28.1x_2+2T2016', 'course-v1:MITx+7.28.2x_1+2T2016', 'course-v1:MITx+7.QBWx_3+1T2016', 'course-v1:MITx+7.QBWx_4+3T2016', 'course-v1:MITx+8.05x_1+3T2015', 'course-v1:MITx+Bootcamp1+3T2017', 'course-v1:MITx+Bootcamp2+3T2017', 'course-v1:MITx+Bootcamp3+3T2017', 'course-v1:MITx+ENx+2016_3T', 'course-v1:MITx+JPAL101x_3+1T2015', 'course-v1:MITx+JPAL101x_4+3T2015', 'course-v1:MITx+JPAL101x_5+2T2016', 'course-v1:MITx+JPAL101x_6+3T2016', 'course-v1:MITx+Launch.x+2T2017', 'course-v1:MITx+Launch.x_2+2T2016', 'course-v1:MITx+Launch.x_3+1T2017', 'course-v1:MITx+uINOV8x+2T2015', 'course-v1:MITx+uINOV8x_1+2T2016', 'course-v1:MITx+uINOV8x_TUR+3T2015', 'course-v1:MITx_PRO+ENx+1T2019', 'course-v1:MITx_PRO+SRRDx1+2T2018', 'course-v1:MITx_PRO+SRRDx2+2T2018', 'course-v1:MongoDBx+M101x+2T2016', 'course-v1:NYIF+YCA2015.1.2x+2016', 'course-v1:Peking+01139732x+3T2015', 'course-v1:PekingX+02534010+1T2016', 'course-v1:PekingX+03530370x+2015T1', 'course-v1:PennX+Trends1x+3T2015', 'course-v1:PrincetonX+CaseStudies101+3T2015', 'course-v1:PrincetonX+MGW+1T2017', 'course-v1:PurdueX+FINANCEx+2016_T1', 'course-v1:PurdueX+PN-15.2+2015_3T', 'course-v1:PurdueX+PN-16.1+2T2016', 'course-v1:RiceX+BIOC372.1x+2015T2', 'course-v1:RiceX+BIOC372.2x+2015T2', 'course-v1:RiceX+BIOC372.3x+1T2017', 'course-v1:SaveALifeX+ACLS101x+3T2015', 'course-v1:SaveALifeX+BLS101x+3T2015', 'course-v1:SaveALifeX+CPR101x+3T2015', 'course-v1:SDGAcademyX+T4DEV001+1T2019', 'course-v1:SmithsonianX+POPX1.1x+2015_T2', 'course-v1:SmithsonianX+POPX1.2x+2015_T2', 'course-v1:SmithsonianX+POPX1.3x+2016_T1', 'course-v1:SmithsonianX+POPX1.4x+2T2016', 'course-v1:SmithsonianX+POPX2.1+2T2016', 'course-v1:SmithsonianX+USHIS1.1x+2015_T2', 'course-v1:SNUx+SNU1831.2x+1T2019', 'course-v1:TeachersCollegeX+BDE1x+2T2015', 'course-v1:TeachForAmericaX+HSMATH2.1x+3T2016', 'course-v1:TeachForAmericaX+SJSM.TFAx+1T2017', 'course-v1:TecdeMonterreyX+EPPE1ed1+1T2019', 'course-v1:TenarisUniversityX+CNC.ETRRx_3+2T2017', 'course-v1:TenarisUniversityX+PIPE01x+2T2015', 'course-v1:TenarisUniversityX+PIPE02x+3T2015', 'course-v1:TenarisUniversityX+STEEL101x+2T2015', 'course-v1:TenarisUniversityX+STEEL101x_1+2T2017', 'course-v1:tennessee+FYS100+F2015', 'course-v1:TrinityX+T002x+3T2015', 'course-v1:TsinghuaX+30240184x+3T2015', 'course-v1:TUMx+EASEx+2T2017', 'course-v1:TUMx+QEMx+2T2016', 'course-v1:UBCx+Climate101x+3T2015', 'course-v1:UBCx+FamBiz1x+1T2017', 'course-v1:UBCx+Marketing1x+3T2015', 'course-v1:UBCx+Marketing5501x+2T2015', 'course-v1:UBCx+SPD1x+2T2016', 'course-v1:UC3Mx+HGA.2x+2016_T2', 'course-v1:UC3Mx+IT.2x+3T2018', 'course-v1:UCSanDiegoX+BINF180.1x+3T2017', 'course-v1:University_of_TorontoX+BE101x+1T2018', 'course-v1:University_of_TorontoX+BE101x_3+1T2016', 'course-v1:UPMCx+LaMalAlz1+1T2018', 'course-v1:UPMCx+Obesite1+1T2018', 'course-v1:UPV+IQ101.4x+2T2016', 'course-v1:UQx+HYPERS301.x+1T2015', 'course-v1:UQx+Tropic101+2T2016', 'course-v1:UTArlingtonX+LINK-LA-CAPx+2T2018', 'course-v1:UTArlingtonX+LINK-LA-MMx+2T2018', 'course-v1:UTArlingtonX+LINK-LA-PMx+1T2018', 'course-v1:UTArlingtonX+LINK-LA-SDx+1T2018', 'course-v1:UTAustinX+UT.5.03x+2T2015', 'course-v1:UTAustinX+UT.5.04x+3T2016', 'course-v1:UTAustinX+UT.6.03x+1T2016', 'course-v1:UTAustinX+UT.7.10x+1T2016', 'course-v1:UTAustinX+UT.7.20x+1T2016', 'course-v1:UTAustinX+UT.7.21x+3T2016', 'course-v1:UTAustinX+UT.IITL.11.01x+3T2016', 'course-v1:UTAustinX+UT.PQ.14.01x+1T2017', 'course-v1:UTAustinX+UT.PreC.10.02x+1T2016', 'course-v1:UTAustinX+UT.WTCS.14.01x+2T2017', 'course-v1:UTAx+CSE1309x+2016T1', 'course-v1:WageningenX+BB01x+3T2017', 'course-v1:WageningenX+BB02x+3T2017', 'course-v1:WageningenX+BB03x+1T2018', 'course-v1:WageningenX+BB04x+3T2017', 'course-v1:WageningenX+BB05x+3T2017', 'course-v1:WageningenX+BB06x+3T2017', 'course-v1:WBGx+F4D01x+1T2017', 'course-v1:WellesleyX+ANTH207x_2+2T2015', 'course-v1:WhartonOnline+Preview_DigitalMarketing1.1x+2T2017', 'DartmouthX/DART.ENVS.01.X/2015_T1', 'DavidsonX/001x/1T2014', 'DavidsonX/D.001x/3T2014', 'DelftX/AE.1110x/3T2014', 'DelftX/CTB3365x/2013_Fall', 'DelftX/EconSec101x/1T2015', 'DelftX/ET.3034TU/3T2014', 'DelftX/ET3034TUx/2013_Fall', 'DelftX/NGI101x/1T2014', 'DelftX/NGI102x/3T2014', 'DelftX/TW.3421x/1T2015', 'edX/GWPx/2014_T1', 'EPFLx/BIO465x/2013_OND', 'EPFLx/EE-102Bx/1T2014', 'GEMSx/GE001x/1T2015', 'GeorgetownX/GUIX-501-01x/3T2014', 'GeorgetownX/HUMX421-01x/3T2014', 'GeorgetownX/HUMX423-01x/1T2015', 'GeorgetownX/INFX523-01/2013_Fall', 'GeorgetownX/INFX523-02x/3T2014', 'GeorgetownX/phlx101-01/1T2014', 'HarvardX/AI12.1x/2013_SOND', 'HarvardX/AI12.2x/2013_SOND', 'HarvardX/CB22.1x/2013_SOND', 'HarvardX/CB22x/2013_Spring', 'HarvardX/GSE1.1x/3T2014', 'HarvardX/GSE1x/2014_JFMA', 'HarvardX/HKS211.1x/3T2013', 'HarvardX/HLS1.1x-2/1T2015', 'HarvardX/HLS1.1x/1T2014', 'HarvardX/PH207x/2012_Fall', 'HarvardX/PH278x/2013_Spring', 'HarvardX/PH525.8x/1T2015', 'HarvardX/SW12x/2013_SOND', 'HarvardX/SW25x/1T2014', 'HarvardX/SW47.1x/2014_T3', 'HKUSTx/COMP102x/2T2014', 'IDBx/IDB2x/3T2014', 'IEEEx/ISSCCx/3T2014', 'IITBombayX/ME209x/2T2014', 'LouvainX/Louv1.01x/1T2014', 'LouvainX/Louv2.01x/1T2014', 'LouvainX/Louv3.01x/1T2014', 'LouvainX/Louv3.02x/3T2014', 'LouvainX/Louv4.01x/1T2014', 'McGillX/ATOC185x_2/1T2015', 'McGillX/CHEM181x_2/3T2014', 'MITx/12_340x/1T2014', 'MITx/14_73x/1T2014', 'MITx/15.071x_2/1T2015', 'MITx/15.390.1x_TUR/1T2015', 'MITx/15.390.2x_TUR/1T2015', 'MITx/15.390x/1T2014', 'MITx/15.S23x/3T2014', 'MITx/21W.789x/1T2014', 'MITx/21W.789x_2/1T2015', 'MITx/24.00_1x/3T2014', 'MITx/3.032x/3T2014', 'MITx/3.086-2x/1T2015', 'MITx/3.091x_2/1T2014', 'MITx/3.091x_3/3T2014', 'MITx/4.605x_2/3T2014', 'MITx/6.002x/2013_Spring', 'MITx/6.002_4x/3T2014', 'MITx/6.00x/2013_Spring', 'MITx/6.041x/1T2014', 'MITx/6.041x_1/1T2015', 'MITx/6.341x/3T2014', 'MITx/6.832x/3T2014', 'MITx/7.00x_2/2T2014', 'MITx/7.QBW_1x/1T2015', 'MITx/8.01x/2013_SOND', 'MITx/8.02x/2013_Spring', 'MITx/8.05x/1T2015', 'MITx/8.MechCx/1T2015', 'MITx/8.MReV/2013_Summer', 'MITx/EECS.6.002x/3T2013', 'MITx/JPAL101_1x/3T2014', 'MITx/MAS.S69x/1T2014', 'OECx/PH241x/3T2014', 'PekingX/02030330x/3T2013', 'PekingX/04832430X/3T2013', 'PekingX/532001x/3T2014', 'PurdueX/pncom201501x/2015_T1', 'RiceX/AdvENVSCI.1x/2014T3', 'RiceX/BIOC372.1x-F14/2T2014', 'RiceX/ELEC301x/T1_2014', 'RiceX/LabSafety.1x/3T2016', 'RiceX/MedDigX/2T2015', 'RiceX/PHYS102x/2013_Oct', 'RiceX/PHYS_102x/1T2014', 'TsinghuaX/00690242.x/1T2015', 'TsinghuaX/00690242_1x/1T2014', 'TsinghuaX/00690242_2x/3T2014', 'TsinghuaX/20220332X/3T2013', 'TsinghuaX/20220332_2x/1T2014', 'TsinghuaX/30240184.x/3T2014', 'TsinghuaX/30240184_x/1T2015', 'TsinghuaX/60240013.x/1T2015', 'TsinghuaX/80000901_1X/3T2013', 'TsinghuaX/80000901_2x/1T2014', 'TsinghuaX/80512073.x/3T2014', 'TsinghuaX/80512073_x/1T2015', 'UBCx/China300x/3T2014', 'UBCx/Water201x/3T2014', 'University_of_TorontoX/BE101x_2/3T2014', 'University_of_TorontoX/LA101x/1T2014', 'UPValenciaX/EX101x/2T2015', 'UTArlingtonX/ENGR1.0x/2T2015', 'UTAustinX/UT.2.01x/2013_Sept', 'UTAustinX/UT.3.01x/2013_Sept', 'UTAustinX/UT.4.01x/2013_Sept', 'UTAustinX/UT.5.01x/1T2014', 'UTAustinX/UT.5.02x/1T2015', 'UTAustinX/UT.6.02x/1T2015', 'UTAustinX/UT.7.01x/3T2014', 'UTAustinX/UT.8.01x/1T2014', 'UTAustinX/UT.8.02x/1T2015', 'UTAustinX/UT.PreC.10.01x/3T2015', 'UWashingtonX/AA432x/3T2014', 'UWashingtonX/COMM220UWx/1T2014', 'VJx/VJx/3T2014', 'WellesleyX/ANTH_207x/2013_SOND', 'WellesleyX/SOC108x/2014_SOND')
        for run in CourseRun.objects.filter(key__in=keys, status=CourseRunStatus.Published).iterator():
            with atomic():
                logger.info('Unpublishing {key}'.format(key=run.key))
                run.status = CourseRunStatus.Unpublished
                run.save(send_emails=False)
                if run.draft_version:
                    run.draft_version.status = CourseRunStatus.Unpublished
                    run.draft_version.save(send_emails=False)
