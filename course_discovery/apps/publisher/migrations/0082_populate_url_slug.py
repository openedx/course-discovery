# -*- coding: utf-8 -*-
# Generated by Django 1.11.23 on 2019-08-27 21:10
from __future__ import unicode_literals

from django.db import migrations

def migrate_data_forward(apps, schema_editor):
    Course = apps.get_model('publisher', 'course')
    DiscoveryCourse = apps.get_model('course_metadata', 'course')
    for instance in Course.objects.all():
        # recreate organization() and partner() methods
        organization = instance.organizations.all().first()
        partner = organization.partner if organization else None
        key = '{org}+{number}'.format(org=instance.organizations.first().key, number=instance.number)
        try:
            discovery_course = DiscoveryCourse.objects.get(partner=partner, key=key)
            instance.url_slug = discovery_course.url_slug
        except:
            pass
        # will set the url_slug if not already set
        instance.save()

class Migration(migrations.Migration):

    dependencies = [
        ('course_metadata', '0196_save_all_url_slugs'),
        ('publisher', '0081_course_url_slug')
    ]

    operations = [
        migrations.RunPython(
            migrate_data_forward,
            migrations.RunPython.noop
        ),
    ]
